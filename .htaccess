# BEGIN Theme
SetEnv HTACCESS on
Options -Indexes

<IfModule mod_headers.c>
    Header set Content-Security-Policy "upgrade-insecure-requests;"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"

    <FilesMatch "\.(css|js)$">
        Header set X-Robots-Tag "noindex, nofollow"
    </FilesMatch>
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On

    #------------------------------
    # WHITELIST – (Google, Meta, Bing, Apple....)
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (googlebot|google|bingbot|applebot) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (facebookexternalhit|facebot|meta-externalagent) [NC]
    RewriteRule ^ - [L]

    #------------------------------
    # BLOCK AI CRAWLERS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (gptbot|gpt\-crawler|anthropic|claudebot|perplexity|pplx|google-extended) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK BAD SEO BOTS / SCRAPERS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (ahrefs|semrush|mj12|dotbot|megaindex|seoscanners|crawler4j|python-requests|zgrab|nikto|sqlmap|blexbot|blex|seranking) [NC]
    RewriteRule ^ - [F,L]

    # Bad generic scraping tools
    RewriteCond %{HTTP_USER_AGENT} (curl|wget|python|urllib|okhttp|libwww|httpclient|http\ client) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK AMAZON / AWS BOTS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (amazonbot|amazon-route53-health-check|alexa|aws) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK CHINA SPIDERS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (baiduspider|360spider|sogou|yisouspider|bytespider) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK RUSSIAN SPIDERS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (yandex|mail\.ru) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK EMPTY USER AGENT
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} ^$
    RewriteRule ^ - [F,L]

    #------------------------------
    # BLOCK BY IP RANGES (China / Russia / OpenAI)
    #------------------------------

    # OpenAI / Azure (AI Crawlers)
    RewriteCond %{REMOTE_ADDR} ^20\. [OR]
    RewriteCond %{REMOTE_ADDR} ^40\.
    RewriteRule ^ - [F,L]

    # China
    RewriteCond %{REMOTE_ADDR} ^36\. [OR]
    RewriteCond %{REMOTE_ADDR} ^42\. [OR]
    RewriteCond %{REMOTE_ADDR} ^58\. [OR]
    RewriteCond %{REMOTE_ADDR} ^101\. [OR]
    RewriteCond %{REMOTE_ADDR} ^110\. [OR]
    RewriteCond %{REMOTE_ADDR} ^111\. [OR]
    RewriteCond %{REMOTE_ADDR} ^112\. [OR]
    RewriteCond %{REMOTE_ADDR} ^113\. [OR]
    RewriteCond %{REMOTE_ADDR} ^123\.
    RewriteRule ^ - [F,L]

    # Russia
    RewriteCond %{REMOTE_ADDR} ^5\. [OR]
    RewriteCond %{REMOTE_ADDR} ^31\. [OR]
    RewriteCond %{REMOTE_ADDR} ^37\. [OR]
    RewriteCond %{REMOTE_ADDR} ^46\. [OR]
    RewriteCond %{REMOTE_ADDR} ^78\. [OR]
    RewriteCond %{REMOTE_ADDR} ^94\.
    RewriteRule ^ - [F,L]

    #------------------------------
    # PROTECT WP-LOGIN / XMLRPC AGAINST BOT ATTACKS
    #------------------------------
    RewriteCond %{REQUEST_URI} /(wp-login\.php|xmlrpc\.php)$ [NC]
    RewriteCond %{HTTP_USER_AGENT} (bot|crawl|spider|scanner|python|curl|wget|libwww) [NC]
    RewriteRule ^ - [F,L]

    #------------------------------
    # RATE LIMIT BOTS
    #------------------------------
    RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider) [NC]
    RewriteRule ^ - [E=THROTTLE:10/60]

    #------------------------------
    # Redirect HTTP → HTTPS
    #------------------------------
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Multisite
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]

    # Add trailing slash to /wp-admin
    RewriteRule ^([_0-9a-zA-Z-]+/)?wp-admin$ $1wp-admin/ [R=301,L]

    # If file or directory exists, do nothing
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Rewrite wp-content, wp-admin, wp-includes, PHP files into src/
    RewriteRule ^([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) src/$2 [L]
    RewriteRule ^([_0-9a-zA-Z-]+/)?(.*\.php)$ src/$2 [L]

    # load index.php in root
    RewriteRule . /index.php [L]
</IfModule>
# END Theme

# BEGIN WordPress
# The directives (lines) between "BEGIN WordPress" and "END WordPress" are
# dynamically generated, and should only be modified via WordPress filters.
# Any changes to the directives between these markers will be overwritten.
# END WordPress
